
-- Set the options to support indexed views.
SET NUMERIC_ROUNDABORT OFF;
SET ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, ARITHABORT,
   QUOTED_IDENTIFIER, ANSI_NULLS ON;

GO


CREATE OR ALTER VIEW dbo.ImageScanVulnerabilityAggregation
WITH SCHEMABINDING
AS
SELECT
	s.Id AS ImageScanId,
	v.Severity,
	COUNT_BIG(*) AS Count
FROM
	dbo.ImageScan s
	INNER JOIN dbo.ImageScanVulnerabilities sv ON s.Id=sv.ImageScanId
	INNER JOIN dbo.Vulnerability v ON sv.VulnerabilityId=v.Id
GROUP BY
	s.Id, v.Severity
go

GRANT SELECT ON dbo.ImageScanVulnerabilityAggregation TO radixreader
GRANT SELECT ON dbo.ImageScanVulnerabilityAggregation TO radixwriter

if EXISTS(select 1 from sys.views where object_id=OBJECT_ID('dbo.ImageScanVulnerabilityAggregation'))
	AND NOT EXISTS(select 1 from sys.indexes WHERE object_id=OBJECT_ID('dbo.ImageScanVulnerabilityAggregation') AND index_id=1)
BEGIN
	CREATE UNIQUE CLUSTERED INDEX ux_ImageScanVulnerabilityAggregation 
		ON dbo.ImageScanVulnerabilityAggregation(ImageScanId, Severity)
END