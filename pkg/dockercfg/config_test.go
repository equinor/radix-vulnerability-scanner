package dockercfg_test

import (
	"context"
	"testing"

	"github.com/equinor/radix-vulnerability-scanner/pkg/dockercfg"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestGetAuthValid(t *testing.T) {
	cfg := dockercfg.New().AddAuth("anyregistry.io", "admin", "password")
	auth, err := cfg.GetAuth(context.Background(), "anyregistry.io/anyimage:anytag")
	require.NoError(t, err)

	assert.Equal(t, "admin", auth.Username)
	assert.Equal(t, "password", auth.Password)
}

func TestMissingGetAuthIsEmpty(t *testing.T) {
	auth, err := dockercfg.New().GetAuth(context.Background(), "anyregistry.io/anyimage:anytag")
	require.NoError(t, err)

	assert.Equal(t, "", auth.Username)
	assert.Equal(t, "", auth.Password)
}

func TestGetAuth_InvalidImageErrors(t *testing.T) {
	_, err := dockercfg.New().GetAuth(context.Background(), "anyregistry.io/:anytag")
	assert.ErrorContains(t, err, "invalid reference format")
}
