package tokensource_test

import (
	"bytes"
	"context"
	"fmt"
	"io"
	"net/http"
	"net/url"
	"testing"

	"github.com/Azure/azure-sdk-for-go/sdk/azcore/fake"
	"github.com/equinor/radix-vulnerability-scanner/pkg/tokenstore/mock"
	"github.com/equinor/radix-vulnerability-scanner/pkg/tokenstore/tokensource"
	"github.com/golang/mock/gomock"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"github.com/stretchr/testify/suite"
)

type AcrTestSuite struct {
	suite.Suite
	client *mock.MockFormPoster
	ctrl   *gomock.Controller
}

func (s *AcrTestSuite) SetupSuite() {
	s.ctrl = gomock.NewController(s.T())
	s.client = mock.NewMockFormPoster(s.ctrl)
}
func Test_AcrSourceTestSuite(t *testing.T) {
	suite.Run(t, new(AcrTestSuite))
}

func (s *AcrTestSuite) TestGetToken() {
	fakeToken := "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyNTkwMjN9.0SDkcr_pdPoY95pDEfzA1sV8RiuY7H69-GUQ9kRdLso"
	s.client.EXPECT().PostForm(
		"https://radix.azurecr.io/oauth2/exchange",
		url.Values{
			"grant_type":   []string{"access_token"},
			"service":      []string{"radix.azurecr.io"},
			"access_token": []string{"fake_token"},
		},
	).Return(&http.Response{
		StatusCode: http.StatusOK,
		Body:       io.NopCloser(bytes.NewBufferString(fmt.Sprintf(`{"refresh_token": "%s"}`, fakeToken))),
	}, nil).Times(1)

	source := tokensource.NewACRTokenSource(
		context.Background(), "radix.azurecr.io",
		tokensource.WithFormPosterOption(s.client),
		tokensource.WithCredentialOption(&fake.TokenCredential{}),
	)

	token, err := source.Token()
	require.NoError(s.T(), err)
	assert.Equal(s.T(), fakeToken, token.AccessToken)
}

func (s *AcrTestSuite) TestGetTokenForbidden() {
	s.client.EXPECT().PostForm(
		"https://radix.azurecr.io/oauth2/exchange",
		url.Values{
			"grant_type":   []string{"access_token"},
			"service":      []string{"radix.azurecr.io"},
			"access_token": []string{"fake_token"},
		},
	).Return(&http.Response{
		StatusCode: http.StatusForbidden,
		Body:       io.NopCloser(bytes.NewBufferString(`{"error": "forbidden"}`)),
	}, nil).Times(1)

	source := tokensource.NewACRTokenSource(
		context.Background(), "radix.azurecr.io",
		tokensource.WithFormPosterOption(s.client),
		tokensource.WithCredentialOption(&fake.TokenCredential{}),
	)

	_, err := source.Token()
	assert.Error(s.T(), err)
}

func TestNonAzureFails(t *testing.T) {
	defer func() {
		err := recover().(error)
		assert.ErrorIs(t, err, tokensource.ErrOnlyACRRegistriesAllowed)
	}()

	tokensource.NewACRTokenSource(context.Background(), "radix.evil-cr.io")
}
