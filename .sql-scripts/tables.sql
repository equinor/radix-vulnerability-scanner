

IF NOT EXISTS(SELECT 1 FROM sys.tables WHERE object_id=OBJECT_ID('dbo.Vulnerability'))
BEGIN
	CREATE TABLE dbo.Vulnerability (
		Id INT IDENTITY PRIMARY KEY,
		ExternalId VARCHAR(255) NOT NULL,
		PackageName VARCHAR(255) NOT NULL,
		[Version] varchar(100) NOT NULL,
		[Description] VARCHAR(MAX) NOT NULL,
		Severity VARCHAR(15) NOT NULL,
		CVSS DECIMAL(3,1) NULL,
		CVSSv3 VARCHAR(150) NULL,
		CreationTime DATETIMEOFFSET NOT NULL,
		ModificationTime DATETIMEOFFSET NOT NULL,
		PublicationTime DATETIMEOFFSET NOT NULL,
		DisclosureTime DATETIMEOFFSET NULL
	)
	CREATE UNIQUE INDEX ux_Vulnerability_ExternalId ON dbo.Vulnerability(ExternalId)
END


IF NOT EXISTS(SELECT 1 FROM sys.tables WHERE object_id=OBJECT_ID('dbo.VulnerabilityReferences'))
BEGIN
	CREATE TABLE dbo.VulnerabilityReferences (
		VulnerabilityId INT NOT NULL,
		[Url] varchar(255) NOT NULL,
		CONSTRAINT pk_VulnerabilityReferences PRIMARY KEY(VulnerabilityId, [Url])
	)
END


IF NOT EXISTS(SELECT 1 FROM sys.tables WHERE object_id=OBJECT_ID('dbo.VulnerabilityIdentifiers'))
BEGIN
	CREATE TABLE dbo.VulnerabilityIdentifiers (
		VulnerabilityId INT NOT NULL,
		IdentifierType CHAR(3) NOT NULL,
		Identifier VARCHAR(50),
		CONSTRAINT pk_VulnerabilitiyIdentifiers PRIMARY KEY(VulnerabilityId, IdentifierType, Identifier)
	)
END


IF NOT EXISTS(SELECT 1 FROM sys.tables WHERE object_id=OBJECT_ID('dbo.[Image]'))
BEGIN
	CREATE TABLE dbo.[Image] (
		Id INT IDENTITY PRIMARY KEY,
		[Name] varchar(255) NOT NULL
	)
	CREATE UNIQUE INDEX ux_Image_Name ON dbo.[Image]([Name])
END


IF NOT EXISTS(SELECT 1 FROM sys.tables WHERE object_id=OBJECT_ID('dbo.ImageScan'))
BEGIN
	CREATE TABLE dbo.ImageScan (
		Id INT IDENTITY PRIMARY KEY,
		ImageId INT NOT NULL,
		ScanTime DATETIMEOFFSET NOT NULL,
		ScanSuccess BIT NOT NULL,
		CONSTRAINT fk_ImageScan_ImageId FOREIGN KEY(ImageId) REFERENCES dbo.[Image](Id) ON DELETE CASCADE
	)
	CREATE INDEX ix_ImageScan_ImageIdScanTime ON dbo.ImageScan(ImageId, ScanTime)
END


IF NOT EXISTS(SELECT 1 FROM sys.tables WHERE object_id=OBJECT_ID('dbo.ImageScanVulnerabilities'))
BEGIN
	CREATE TABLE dbo.ImageScanVulnerabilities (
		ImageScanId INT NOT NULL,
		VulnerabilityId INT NOT NULL,
		CONSTRAINT pk_ImageScanVulnerabilities PRIMARY KEY(ImageScanId, VulnerabilityId),
		CONSTRAINT fk_ImageScanVulnerabilities_ImageScanId FOREIGN KEY(ImageScanId) REFERENCES dbo.ImageScan(Id) ON DELETE CASCADE,
		CONSTRAINT fk_ImageScanVulnerabilities_VulnerabilityId FOREIGN KEY(VulnerabilityId) REFERENCES dbo.Vulnerability(Id) ON DELETE CASCADE
	)
	CREATE UNIQUE INDEX ux_ImageScanVulnerabilities_VulnerabilityIdImageScanId on dbo.ImageScanVulnerabilities(VulnerabilityId, ImageScanId)
END

